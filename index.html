<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kontrol Lampu Rumah - Smart Home</title>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
      import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

      const FIREBASE_KEY = [
      "AIzaSyAIaV8GRl",    // bagian 1
      "Njtxylgbrh92u", // bagian 2
      "K6NYjST1-Nws"     // bagian 3
    ].join("");


      // const firebaseConfig = { /* config kamu di sini */ };

      // Import the functions you need from the SDKs you need
      // import { initializeApp } from "firebase/app";
      // import { getAnalytics } from "firebase/analytics";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: FIREBASE_KEY,
        authDomain: "project-led-7fc38.firebaseapp.com",
        databaseURL: "https://project-led-7fc38-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "project-led-7fc38",
        storageBucket: "project-led-7fc38.firebasestorage.app",
        messagingSenderId: "920656649431",
        appId: "1:920656649431:web:36ad87239e2a278f5b2492",
        measurementId: "G-QS8XG5G3YK"
      };

      // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.db = db;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebaseChild = child;
        window.dbRef = ref(window.db); // root reference


    </script>


    <style>
        /* === ROOT VARIABLES & RESET === */
        :root {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-card: #242424;
            --bg-card-on: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --text-muted: #666666;
            --accent-primary: #4ade80;
            --accent-secondary: #22c55e;
            --accent-off: #525252;
            --border-color: #333333;
            --shadow-color: rgba(0, 0, 0, 0.5);
            --glow-color: rgba(74, 222, 128, 0.15);
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            
            --font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --border-radius: 12px;
            --transition: all 0.25s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-family);
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* === LAYOUT === */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* === HEADER === */
        .header {
            text-align: center;
            padding: 2rem 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header .clock {
            font-size: 1.125rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* === TOOLBAR === */
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--bg-card);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }

        .toolbar-group {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .toolbar button {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
            position: relative;
            overflow: hidden;
        }

        .toolbar button:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            transform: translateY(-1px);
        }

        .toolbar button:active {
            transform: translateY(0);
        }

        .toolbar button:focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }

        .toolbar button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .toolbar button.loading {
            pointer-events: none;
        }

        .toolbar button.loading::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            margin: auto;
            border: 2px solid transparent;
            border-top-color: var(--text-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .search-container {
            flex: 1;
            min-width: 250px;
        }

        .search-input {
            width: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--glow-color);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        /* === LIGHTS GRID === */
        .lights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            flex: 1;
            margin-bottom: 2rem;
        }

        .light-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .light-card.on {
            background: var(--bg-card-on);
            box-shadow: 0 0 20px var(--glow-color);
            border-color: var(--accent-primary);
        }

        .light-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--shadow-color);
        }

        .light-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .light-name {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .light-status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-off);
            transition: var(--transition);
        }

        .light-status-indicator.on {
            background: var(--accent-primary);
            box-shadow: 0 0 6px var(--accent-primary);
        }

        .light-body {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .light-icon {
            font-size: 2rem;
            transition: var(--transition);
            opacity: 0.4;
        }

        .light-icon.on {
            opacity: 1;
            filter: drop-shadow(0 0 8px var(--accent-primary));
        }

        .light-toggle {
            position: relative;
            width: 60px;
            height: 32px;
            background: var(--accent-off);
            border: none;
            border-radius: 16px;
            cursor: pointer;
            transition: var(--transition);
            outline: none;
        }

        .light-toggle::after {
            content: "";
            position: absolute;
            width: 26px;
            height: 26px;
            background: white;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: var(--transition);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .light-toggle.on {
            background: var(--accent-primary);
        }

        .light-toggle.on::after {
            transform: translateX(28px);
        }

        .light-toggle:focus-visible {
            box-shadow: 0 0 0 3px var(--glow-color);
        }

        .light-toggle:hover {
            transform: scale(1.05);
        }

        .light-status-text {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .light-status-text.on {
            color: var(--accent-primary);
        }

        /* === NOTIFICATIONS === */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--accent-primary);
            color: var(--bg-primary);
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: var(--error-color);
        }

        /* === FOOTER === */
        .footer {
            text-align: center;
            padding: 2rem 0;
            border-top: 1px solid var(--border-color);
            color: var(--text-muted);
            font-size: 0.875rem;
            margin-top: auto;
        }

        /* === ANIMATIONS === */
        @keyframes spin {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading-pulse {
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .container {
                padding: 0.75rem;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .lights-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .toolbar {
                flex-direction: column;
                gap: 1rem;
            }
            
            .toolbar-group {
                justify-content: center;
            }
            
            .search-container {
                min-width: auto;
            }
        }

        @media (max-width: 400px) {
            .header {
                padding: 1.5rem 0;
            }
            
            .header h1 {
                font-size: 1.75rem;
            }
            
            .light-card {
                padding: 1.25rem;
            }
            
            .toolbar {
                padding: 1.25rem;
            }
        }

        /* === ACCESSIBILITY === */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* === HIDDEN CLASS FOR SEARCH === */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>

    <!-- Login Form -->
    <div id="loginPanel" style="max-width:400px;margin:2rem auto;padding:1rem;background:#1a1a1a;border-radius:8px;text-align:center;">
        <h2>Login</h2>
        <input type="email" id="email" placeholder="Email" style="width:100%;padding:0.5rem;margin:0.5rem 0;">
        <input type="password" id="password" placeholder="Password" style="width:100%;padding:0.5rem;margin:0.5rem 0;">
        <button id="loginBtn" style="padding:0.5rem 1rem;margin:0.5rem;">Login</button>
        <!-- <button id="logoutBtn" style="padding:0.5rem 1rem;margin:0.5rem;">Logout</button> -->
        <p id="statusText" style="margin-top:1rem;color:#ccc;"></p>
    </div>
    <!-- End Login Form -->
    <!-- Control Panel Wrapper -->
    <div id="controlPanel" style="display:none;">

    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>Kontrol Lampu Rumah</h1>
            <div class="clock" id="clock"></div>
        </header>

        <!-- Toolbar -->
        <div class="toolbar">
            <div class="toolbar-group">
                <button id="allOnBtn" aria-label="Nyalakan semua lampu">üî• Semua ON</button>
                <button id="allOffBtn" aria-label="Matikan semua lampu">‚ùÑÔ∏è Semua OFF</button>
                <button id="refreshBtn" aria-label="Refresh status lampu">üîÑ Refresh Status</button>
                <button id="logoutBtn" style="display:none;">üö™ Logout</button>
            </div>
            <div class="search-container">
                <input 
                    type="text" 
                    class="search-input" 
                    id="searchInput" 
                    placeholder="üîç Cari ruangan..."
                    aria-label="Cari ruangan"
                >
            </div>
        </div>

        <!-- Lights Grid -->
        <main class="lights-grid" id="lightsGrid">
            <!-- Light cards will be generated by JavaScript -->
        </main>

</div> <!-- End Control Panel -->

        <!-- Footer -->
        <footer class="footer">
            <p>¬© 2025 Smart Home</p>
        </footer>
    </div>

    <!-- Notification Container -->
    <div id="notification" class="notification"></div>

    <script>
        // === CONFIGURATION ===
        const LIGHTS_CONFIG = {
            front_yard: 'Halaman Depan',
            living_room: 'Ruang Tamu',
            tv_room: 'Ruang TV',
            bedroom_1: 'Kamar 1',
            bedroom_2: 'Kamar 2',
            kitchen: 'Dapur',
            bathroom: 'Kamar Mandi',
            garage: 'Bagasi',
            garage_front: 'Depan Bagasi'
        };

        // === GLOBAL STATE ===
        let lightsState = {};
        let isLoading = false;

        // === UTILITY FUNCTIONS ===

        /**
         * Load state from localStorage
         */
        function loadState() {
            try {
                const saved = localStorage.getItem('smart-home-lights');
                if (saved) {
                    lightsState = JSON.parse(saved);
                } else {
                    // Initialize default state (all lights OFF)
                    lightsState = {};
                    Object.keys(LIGHTS_CONFIG).forEach(id => {
                        lightsState[id] = false;
                    });
                    saveState();
                }
            } catch (error) {
                console.error('Error loading state:', error);
                // Initialize default state on error
                lightsState = {};
                Object.keys(LIGHTS_CONFIG).forEach(id => {
                    lightsState[id] = false;
                });
            }
        }

        /**
         * Save state to localStorage
         */
        function saveState() {
            try {
                localStorage.setItem('smart-home-lights', JSON.stringify(lightsState));
                showNotification('Tersimpan', 'success');
            } catch (error) {
                console.error('Error saving state:', error);
                showNotification('Gagal menyimpan', 'error');
            }
        }

        /**
         * Show notification
         */
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            
            // Show notification
            notification.classList.add('show');
            
            // Hide after 1.5 seconds
            setTimeout(() => {
                notification.classList.remove('show');
            }, 1500);
        }

        /**
         * Update clock display
         */
        function setNowClock() {
            const now = new Date();
            const timeString = now.toLocaleString('id-ID', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('clock').textContent = timeString;
        }

        /**
         * Create light card HTML
         */
        function createLightCard(id, name) {
            const isOn = lightsState[id];
            return `
                <div class="light-card ${isOn ? 'on' : ''}" id="card-${id}">
                    <div class="light-header">
                        <h3 class="light-name">${name}</h3>
                        <div class="light-status-indicator ${isOn ? 'on' : ''}" id="indicator-${id}"></div>
                    </div>
                    <div class="light-body">
                        <div class="light-icon ${isOn ? 'on' : ''}" id="icon-${id}">üí°</div>
                        <button 
                            class="light-toggle ${isOn ? 'on' : ''}" 
                            id="toggle-${id}"
                            aria-label="Toggle ${name}"
                            onclick="toggleOne('${id}')"
                            onkeydown="handleToggleKeydown(event, '${id}')"
                        ></button>
                    </div>
                    <div class="light-status-text ${isOn ? 'on' : ''}" id="status-${id}">
                        ${isOn ? 'Menyala' : 'Mati'}
                    </div>
                </div>
            `;
        }

        /**
         * Apply UI from current state
         */
        function applyUIFromState() {
            Object.keys(LIGHTS_CONFIG).forEach(id => {
                const isOn = lightsState[id];
                const card = document.getElementById(`card-${id}`);
                const toggle = document.getElementById(`toggle-${id}`);
                const indicator = document.getElementById(`indicator-${id}`);
                const icon = document.getElementById(`icon-${id}`);
                const status = document.getElementById(`status-${id}`);

                if (card && toggle && indicator && icon && status) {
                    // Update classes
                    card.className = `light-card ${isOn ? 'on' : ''}`;
                    toggle.className = `light-toggle ${isOn ? 'on' : ''}`;
                    indicator.className = `light-status-indicator ${isOn ? 'on' : ''}`;
                    icon.className = `light-icon ${isOn ? 'on' : ''}`;
                    status.className = `light-status-text ${isOn ? 'on' : ''}`;
                    
                    // Update status text
                    status.textContent = isOn ? 'Menyala' : 'Mati';
                }
            });
        }

        /**
         * Handle keyboard interaction for toggles
         */
        function handleToggleKeydown(event, id) {
            if (event.key === ' ' || event.key === 'Enter') {
                event.preventDefault();
                toggleOne(id);
            }
        }

        /**
         * Toggle single light
         */
        async function toggleOne(id, newState = null) {
            if (isLoading) return;
            
            const currentState = lightsState[id];
            const targetState = newState !== null ? newState : !currentState;
            
            // Optimistically update UI
            lightsState[id] = targetState;
            applyUIFromState();
            
            try {
                await sendCommand(id, targetState);

                saveState();
            } catch (error) {
                // Revert on error
                lightsState[id] = currentState;
                applyUIFromState();
                showNotification('Gagal mengubah lampu', 'error');
            }
        }

        /**
         * Toggle all lights
         */
        async function toggleAll(newState) {
            if (isLoading) return;
            
            const prevState = { ...lightsState };
            
            // Optimistically update all lights
            Object.keys(LIGHTS_CONFIG).forEach(id => {
                lightsState[id] = newState;
            });
            applyUIFromState();
            
            setLoadingState(true);
            
            try {
                // Send commands for all lights
                const promises = Object.keys(LIGHTS_CONFIG).map(id => sendCommand(id, newState));
                await Promise.all(promises);
                saveState();
                showNotification(`Semua lampu ${newState ? 'dinyalakan' : 'dimatikan'}`, 'success');
            } catch (error) {
                // Revert on error
                lightsState = prevState;
                applyUIFromState();
                showNotification('Gagal mengubah semua lampu', 'error');
            } finally {
                setLoadingState(false);
            }
        }

        /**
         * Set loading state for buttons
         */
        function setLoadingState(loading) {
            isLoading = loading;
            const buttons = ['allOnBtn', 'allOffBtn'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.disabled = loading;
                    btn.classList.toggle('loading', loading);
                }
            });
        }

        /**
         * Send command to ESP32 (STUB)
         * This function simulates sending HTTP requests to ESP32
         */
        async function sendCommand(roomId, state) {
             const { set, ref } = await import("https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js");
            await set(ref(window.db, "lights/" + roomId), state);
        }

        /**
         * Fetch status from ESP32 (STUB)
         * This function simulates fetching status from ESP32
         */
        async function fetchStatus() {
          console.log('Fetching status from Firebase...');

          setLoadingState(true);

          try {
              // Import fungsi Firebase Database
              const { get, child } = await import("https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js");

              // Ambil snapshot dari path "lights"
              const snapshot = await get(child(window.dbRef, "lights"));

              if (snapshot.exists()) {
                  const statusData = snapshot.val();
                  console.log('Status dari Firebase:', statusData);

                  // Update state dari data Firebase
                  lightsState = statusData;
                  applyUIFromState();
                  saveState();
                  showNotification('Status diperbarui', 'success');
              } else {
                  console.warn('Tidak ada data lights di Firebase');
                  lightsState = {};
                  applyUIFromState();
              }

          } catch (error) {
              console.error('Error fetching status:', error);
              showNotification('Gagal memuat status', 'error');
          } finally {
              setLoadingState(false);
          }
      }


        /**
         * Filter lights based on search query
         */
        function filterLights(query) {
            const searchTerm = query.toLowerCase().trim();
            
            Object.keys(LIGHTS_CONFIG).forEach(id => {
                const card = document.getElementById(`card-${id}`);
                const name = LIGHTS_CONFIG[id].toLowerCase();
                
                if (card) {
                    const matches = searchTerm === '' || name.includes(searchTerm);
                    card.classList.toggle('hidden', !matches);
                }
            });
        }

        /**
         * Initialize the application
         */
        function init() {
            console.log('Initializing Smart Home Light Control...');
            
            // Load saved state
            loadState();
            
            // Generate light cards
            const lightsGrid = document.getElementById('lightsGrid');
            lightsGrid.innerHTML = Object.keys(LIGHTS_CONFIG)
                .map(id => createLightCard(id, LIGHTS_CONFIG[id]))
                .join('');
            
            // Apply initial UI state
            applyUIFromState();
            
            // Start clock
            setNowClock();
            setInterval(setNowClock, 1000);
            
            // Setup event listeners
            document.getElementById('allOnBtn').addEventListener('click', () => toggleAll(true));
            document.getElementById('allOffBtn').addEventListener('click', () => toggleAll(false));
            document.getElementById('refreshBtn').addEventListener('click', fetchStatus);
            
            // Setup search
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', (e) => filterLights(e.target.value));
            
            console.log('Smart Home Light Control initialized successfully!');
        }

        // === APPLICATION STARTUP ===
        document.addEventListener('DOMContentLoaded', init);
        
        // === ERROR HANDLING ===
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            showNotification('Terjadi kesalahan', 'error');
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            showNotification('Terjadi kesalahan jaringan', 'error');
        });
    </script>

    
    <!-- Firebase Auth -->
    <script type="module">
      import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
      const auth = getAuth();

      document.addEventListener('DOMContentLoaded', () => {
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const statusText = document.getElementById('statusText');
        const loginPanel = document.getElementById('loginPanel');
        const controlPanel = document.getElementById('controlPanel');

        loginBtn.addEventListener('click', () => {
          const email = document.getElementById('email').value;
          const password = document.getElementById('password').value;
          signInWithEmailAndPassword(auth, email, password)
            .then(userCredential => {
              statusText.textContent = `Login berhasil: ${userCredential.user.email}`;
            })
            .catch(error => {
              statusText.textContent = `Error: ${error.message}`;
            });
        });

        logoutBtn.addEventListener('click', () => {
          signOut(auth).then(() => {
            console.log('Logout berhasil');
          }).catch(error => {
            console.error('Gagal logout:', error);
          });
        });

        onAuthStateChanged(auth, user => {
          if (user) {
            loginPanel.style.display = 'none';
            controlPanel.style.display = 'block';
            logoutBtn.style.display = 'inline-block';
          } else {
            loginPanel.style.display = 'block';
            controlPanel.style.display = 'none';
            logoutBtn.style.display = 'none';
            statusText.textContent = '';
          }
        });
      });
    </script>


</body>
</html>